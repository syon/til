---
layout: post
title: "別リポジトリのコミットをパッチとして当てる (git format-patch & git am)"
date: 2019-01-14 23:00:00 +0900
categories: [Git]
---

## やりたいこと

小さなリポジトリの技術スタックを試行錯誤しているケースにおいて、ビジネスロジックを維持したまま、フレームワークを換えるシーンを想定している。
具体的なユースケースとして、リニューアル作業を全然別のリポジトリで作業していたが本流に戻したくなった場合を想定している。

メインリポジトリブランチの履歴を維持したまま、別リポジトリブランチの一連コミット群を取り込みたい。
なお、以下のやり方は __コミット日時が維持される。__
つまり、コミットは通常通り並ぶが日時が時系列で並ばない。
（Git的にはコミットが過去から未来へキレイに並ばなくてもよい模様）

また、この例ではメインリポジトリは改修を止めていない。
リニューアル作業を開始してからもコミットを続けている。
実際にこのパッチ適用作業にあたっては、一旦すべてを削除した状態をコミットしてからパッチを適用している。


## 実現方法

### パッチを作成する

取り込みたい内容がコミットされているリポジトリのブランチで以下を実行。`abcd123`は開始コミットのSHA-1。`-o`オプションは出力先ディレクトリ指定。

```sh
git format-patch abcd123 -o ~/downloads/patches
```

- [Git - git-format-patch Documentation](https://git-scm.com/docs/git-format-patch)

コミットごとのパッチファイルが生成される。

- 0001-message-of-commit.patch
- 0002-message-of-commit.patch
- 0003-message-of-commit.patch

### パッチを適用する

取り込み先のメインリポジトリで以下を実行。

```sh
git am --3way ~/downloads/patches/*.patch
```

- [Git - git-am Documentation](https://git-scm.com/docs/git-am)

#### 絵文字コミットコメントがうまくいかない

GitHub向けにコミットコメントの先頭に絵文字変換されるコロン囲みの記述をしていたところ
__git am__ に取り除かれてしまった。

```sh
:tada: Initial commit
```

```sh
tada: Initial commit
```

この問題に対応するには、リベースでコメントだけを修正する。`abcd456`は基点となるコミットのSHA-1で、それより後のコミットが編集対象となる。

```sh
git rebase -i abcd456
```

リベースの取り込みコマンド reword を使ってコメントのみ修正する。
コミットがたくさんあると大変なので Vim のコマンドで置換する。
なお、この画面ではコメントを編集しても意味がないので注意。

```sh
:%s/^pick/reword/g
```

この後、１コミットずつコメント編集画面に切り替わりながら変更作業を繰り返す。
最後まで編集し終わるとリベースが完了する。
